<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <!-- Cabin font -->
    <link href="https://fonts.googleapis.com/css2?family=Cabin:wght@400;600&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Cabin', sans-serif;
        background-color: #f8f0dc;
        color: #333;
        padding: 20px;
        margin: 0;
      }

      .drop-zone {
        border: 2px dashed #3e220f;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin-bottom: 12px;
        background-color: #fffaec;
        transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
      }

      .drop-zone.dragover {
        background-color: #ac7c5a;
        transform: scale(1.02);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }

      .file-name {
        display: inline-block;
        font-weight: 600;
        color: #000000;
        animation: fadeIn 0.5s ease;
      }

      .file-label {
        font-size: 18px;        /* Bigger text */
        font-weight: 600;       /* Bold */
        color: #000000;         /* Dark brown, matches your theme */
        display: block;         /* Make sure it’s on its own line */
        margin-bottom: 6px;     /* Space between label and drop zone */
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
      }

      button {
        width: 100%;               /* Full width of the container */
        max-width: 300px;          /* Optional: prevent it from being too wide */
        margin: 20px auto 0 auto;  /* Center horizontally and add top margin */
        display: block;            /* Required for margin auto to work */
        
        background: linear-gradient(145deg, #3e220f, #552e14);
        color: #fffaec;
        border: none;
        border-radius: 8px;
        padding: 12px 0;           /* Full width, adjust vertical padding */
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      button:hover {
        background: linear-gradient(145deg, #552e14, #70421a);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.2);
      }

      button::after {
        content: '';
        position: absolute;
        top: 0;
        left: -75%;
        width: 50%;
        height: 100%;
        background: rgba(255, 255, 255, 0.2);
        transform: skewX(-25deg);
        transition: all 0.5s ease;
      }

      button:hover::after {
        left: 125%;
      }
    </style>
  </head>

  <body>
    <div id="loadingOverlay" style="
        display: none;
        position: fixed;
        top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.5);
        color: #fff;
        font-size: 24px;
        font-weight: 600;
        text-align: center;
        padding-top: 20%;
        z-index: 9999;
    ">
      Uploading files, please wait...
    </div>

    <div>
      <label class="file-label">Capital One Venture X:</label class="file-label">
      <div id="drop1" class="drop-zone">Drag & drop file here or click to select</div>
      <input type="file" id="file1" accept=".csv" style="display:none;">
    </div>

    <div>
      <label class="file-label">Capital One Savor One:</label class="file-label">
      <div id="drop2" class="drop-zone">Drag & drop file here or click to select</div>
      <input type="file" id="file2" accept=".csv" style="display:none;">
    </div>

    <div>
      <label class="file-label">Chase Amazon:</label class="file-label">
      <div id="drop3" class="drop-zone">Drag & drop file here or click to select</div>
      <input type="file" id="file3" accept=".csv" style="display:none;">
    </div>

    <div>
      <label class="file-label">Venmo:</label class="file-label">
      <div id="drop4" class="drop-zone">Drag & drop file here or click to select</div>
      <input type="file" id="file4" accept=".csv" style="display:none;">
    </div>

    <br>
  <div id="loadingContainer" style="display:none; margin-top:20px; text-align:center;">
    <div style="width:100%; background-color:#ddd; border-radius:8px; overflow:hidden; height:20px;">
      <div id="loadingBar" style="width:0%; height:100%; background-color:#3e220f; text-align:center; color:#fff; line-height:20px; font-weight:bold;">
        0%
      </div>
    </div>
    <div id="loadingText" style="margin-top:5px; font-size:14px;">Uploading...</div>
  </div>
    <button id="uploadBtn">Upload</button>

    <script>
      function setupDropZone(dropId, fileId) {
        const dropZone = document.getElementById(dropId);
        const fileInput = document.getElementById(fileId);

        function showFileName(file) {
          dropZone.innerHTML = "";
          const span = document.createElement("span");
          span.textContent = file.name;
          span.classList.add("file-name");
          dropZone.appendChild(span);
        }

        // Click to open file picker
        dropZone.addEventListener("click", () => fileInput.click());

        // Drag over / leave
        dropZone.addEventListener("dragover", e => {
          e.preventDefault();
          dropZone.classList.add("dragover");
        });
        dropZone.addEventListener("dragleave", e => {
          e.preventDefault();
          dropZone.classList.remove("dragover");
        });

        // Drop file
        dropZone.addEventListener("drop", e => {
          e.preventDefault();
          dropZone.classList.remove("dragover");
          fileInput.files = e.dataTransfer.files;
          if (fileInput.files.length > 0) showFileName(fileInput.files[0]);
        });

        // File picker change
        fileInput.addEventListener("change", () => {
          if (fileInput.files.length > 0) showFileName(fileInput.files[0]);
        });
      }

      // Initialize the 3 drop zones
      setupDropZone("drop1", "file1");
      setupDropZone("drop2", "file2");
      setupDropZone("drop3", "file3");
      setupDropZone("drop4", "file4");

      // Upload logic (aggregated)
      document.getElementById("uploadBtn").addEventListener("click", () => {
        const loadingContainer = document.getElementById("loadingContainer");
        const loadingText = document.getElementById("loadingText");
        const bar = document.getElementById("loadingBar");

        loadingContainer.style.display = "block";
        let progress = 0;
        bar.style.width = progress + "%";
        bar.textContent = progress + "%";
        loadingText.textContent = "Reading Files...";

        const files = [
          {id: "file1", type: "Capital One Venture X"},
          {id: "file2", type: "Capital One Savor One"},
          {id: "file3", type: "Chase Amazon"},
          {id: "file4", type: "Venmo"}
        ];

        // Read all files in browser
        const readPromises = files.map(f => {
          const fileInput = document.getElementById(f.id);
          if (!fileInput.files[0]) return Promise.resolve(null);

          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => {
              google.script.run.withSuccessHandler(resolve)
                .processCSVWithType(e.target.result, f.type);
            };
            reader.onerror = reject;
            reader.readAsText(fileInput.files[0]);
          });
        });

        // Smooth animation helper
        function animateTo(target, speed = 1, callback) {
          const interval = setInterval(() => {
            if (progress < target) {
              progress += speed;
              if (progress > target) progress = target;
              bar.style.width = progress + "%";
              bar.textContent = Math.floor(progress) + "%";
            } else {
              clearInterval(interval);
              if (callback) callback();
            }
          }, 20); // 20ms per tick → smooth
        }

        // Animate 0 → 50% while reading
        animateTo(50, 0.5);

        Promise.all(readPromises).then(results => {
          loadingText.textContent = "Writing to Sheet...";
          // Animate 50 → 90% while waiting for sheet write
          animateTo(90, 0.3);

          google.script.run.withSuccessHandler(() => {
            // Animate 90 → 100% when done
            animateTo(100, 0.5, () => {
              loadingText.textContent = "Done!";
              setTimeout(() => google.script.host.close(), 500);
            });
          }).writeAggregatedTables(results);

        }).catch(err => {
          alert("Error uploading files: " + err);
          loadingContainer.style.display = "none";
        });
      });
    </script>
  </body>
</html>
